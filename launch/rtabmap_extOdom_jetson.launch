<launch>
    <!--APL RTABMap parameters configuration -->
    <arg name="rtabmap_workingDirectory" default="~/user_workspace/.rtabmap"/>
    <arg name="database_path"            default="~/user_workspace/rtabmap.db"/>
    <arg name="rtabmap_cfg"              default="" />
    <arg name="rtabmap_output"           default="screen"/> 
    <arg name="rtabmap_args"             default=""/>
    <arg name="launch_prefix"            default=""/>
    
    <!-- sensors input parameters --> 
    <arg name="odom_topic"              default="/t265/odom/sample"/>
    <arg name="frame_id"                default="t265_link"/>
    <arg name="use_sim_time"            default="false"/>
    <arg name="rgb_topic"               default="/camera/color/image_rect"/>
    <arg name="camera_info_topic"       default="/camera/color/camera_info"/>
    <arg name="depth_topic"             default="/camera/aligned_depth_to_color/image_rect"/>
    <arg name="depth_camera_info_topic" default="/camera/aligned_depth_to_color/camera_info"/>
    <arg name="imageAlreadyRectify"     default="true"/>   <!-- Images are already rectified. By default RTAB-Map assumes that received images are rectified. If they are not, they can be rectified by RTAB-Map if this parameter is false -->
    <arg name="rectifyOnlyFeatures"     default="false"/>  <!-- the whole RGB image will not be rectified, only the features. If imageAlreadyRectify is false otherwise this must be set to true -->
    <arg name="map_frame_id"            default="world"/>
    <arg name="grid_maxObstacleHeight"  default="1.5"/>
    <arg name="raytracing"              default="false"/>

    <!-- mapping configuration -->
    <arg name="rtabmap_detectionRate"          default="6"/>
    <arg name="rgbd_semantic_detection_sync"   default="false"/>
    <arg name="model_classes_file_path"        default="" />
    <arg name="orb_cuda"                       default="true" />
    <arg name="queue_size_rgbd"                default="30"/>  <!--default for depth mode -->
    <arg name="queue_size"                     default="200"/> <!--default for depth mode --> 
    <arg name="multi_level_cell_size"          default="0.05 0.05 0.05 0.05 0.05"/>   <!-- 5 layers supported {ground, ceiling, static, movable, dynamic} resolution of each octree -->
    <arg name="multi_level_cell_name"          default="ground ceiling static movable dynamic"/>   <!-- Name of octree per layer. -->
    <arg name="grid_semanticDepthFusionCorrection"   default="false"/>
    <arg name="grid_semanticGroundCorrection"        default="false"/>
    <arg name="grid_outlierRemoval"                  default="false"/>
    <arg name="octomap_raytracing"                   default="false"/>
    <arg name="grid_raytracingMaxRange"              default="4"/>
    <arg name="grid_rayTracingMaxHeight"             default="1.0"/>
    <arg name="grid_rayTracingMaxWidth"              default="4"/>
    <arg name="grid_rayTracingWithGrd"               default="true"/>
    <arg name="grid_maxGroundHeight"                 default="0.05"/>
    
    <!-- Localization-only mode -->
    <arg name="localization"                default="false"/>
    <arg name="map_always_update"           default="false"/>
    <arg name="bayes_fullPredictionUpdate"  default="false"/>
    <arg name="rgbd_maxOdomCacheSize"       default="0"/>
     
    <!-- ********** RTABMAP ********** -->
    <!-- 
        publish_tf_map : this is argument "publish_tf" for rtabmap; It disables map->odom TF so Rtabmap can use external localization pkgs.
    -->
    <include file="$(find rtabmap_ros)/launch/rtabmap.launch">
        <arg name="output"                  default="$(arg rtabmap_output)"/>
        <arg name="cfg"                     default="$(arg rtabmap_cfg)"/>
        <arg name="rtabmap_args"            value="$(arg rtabmap_args)"/>
        <arg name="launch_prefix"           default="$(arg launch_prefix)"/>
        <arg name="use_sim_time"            default="$(arg use_sim_time)"/>
        <arg name="map_frame_id"            default="$(arg map_frame_id)" />

        <arg name="localization"            default="$(arg localization)" />
        <arg name="visual_odometry"         default="false"/>
        <arg name="odom_topic"              default="$(arg odom_topic)"/>   <!-- Odometry topic name -->  
        <arg name="frame_id"                default="$(arg frame_id)"/>  <!-- fixed body base_link -->
        <!-- <arg name="extern_odom_info"        default="false" /> -->
        <arg name="rgbd_semantic_detection_sync" default="$(arg rgbd_semantic_detection_sync)"/>
        <arg unless="$(arg rgbd_semantic_detection_sync)" name="rgbd_sync" default="true" />
        <arg name="approx_rgbd_sync"        default="true"/>
        
        <!-- RGB-D related topics -->
        <arg name="rgb_topic"               default="$(arg rgb_topic)"/>
        <arg name="camera_info_topic"       default="$(arg camera_info_topic)"/>
        <arg name="depth_topic"             default="$(arg depth_topic)"/>
        <arg name="depth_camera_info_topic" default="$(arg depth_camera_info_topic)"/>

        <!--mapping related parameters -->
        <arg name="rtabmap_workingDirectory"    default="$(arg rtabmap_workingDirectory)"/>
        <arg name="database_path"               default="$(arg database_path)"/>
        <arg name="publish_tf_odom"             default="false"/>
        <arg name="publish_tf_map"              default="true"/>
        <arg name="map_always_update"           default="$(arg map_always_update)"/>
        <arg name="raytracing"                  default="$(arg raytracing)"/>     <!-- this occurs at the occupancy grid only -->
        <arg name="time_threshold"              default="700"/>   <!-- "Rtabmap/TimeThr" : If the map takes longer than this threshold in milliseconds to update then it is moved to long term storage (does not impact octomap) -->
        <arg name="memory_threshold"            default="1000"/>  <!--  "Rtabmap/MemoryThr" : number of nodes in octomap before moved to long-term storage-->
        <arg name="map_resolution"              default="0.05"/>  <!-- "Grid/CellSize": resolution in m of grid/octomap-->
        <arg name="max_nodes"                   default="1000"/>  <!--  "GridGlobal/MaxNodes:" : Maximum nodes assembled in the map starting from the last node (octomap)-->
        <arg name="queue_size"                  default="$(arg queue_size)"/>
        <arg name="rtabmap_detectionRate"       default="$(arg rtabmap_detectionRate)"/>      <!-- "Rtabmap/DetectionRate" : [Detection rate (Hz). RTAB-Map will filter input images to satisfy this rate.] --> 
        <arg name="tf_delay"                    default="0.0667"/>  <!-- (15 Hz: 0.0667 sec) (30 Hz: 0.0334 sec) in order to keep up with the odometry time update-->
        <arg name="queue_size_rgbd"             default="$(arg queue_size_rgbd)"/>
        <arg name="mem_STMSize"                 default="20"/>
        <arg name="bayes_fullPredictionUpdate"  default="$(arg bayes_fullPredictionUpdate)"/>
        <arg name="imageAlreadyRectify"         default="$(arg imageAlreadyRectify)"/>  <!-- /color/image_raw has not been rectified -->
        <arg name="rectifyOnlyFeatures"         default="$(arg rectifyOnlyFeatures)"/>  <!-- projection of RGB-D image to point cloud is assuming that images are rectified, so needs to be true -->
        <arg name="grid_maxObstacleHeight"      default="$(arg grid_maxObstacleHeight)"/>
        <arg name="rgbd_maxOdomCacheSize"       default="$(arg rgbd_maxOdomCacheSize)"/>
        <arg name="rgbd_optimizeMaxError"       default="2"/>
        <!-- <arg name="optimizer_robust"            default="true"/> -->
        <arg name="model_classes_file_path"     default="$(arg model_classes_file_path)"/>
        <arg name="orb_cuda"                    default="$(arg orb_cuda)" />
        <arg name="multi_level_cell_size"       default="$(arg multi_level_cell_size)"/>   
        <arg name="multi_level_cell_name"       default="$(arg multi_level_cell_name)"/>
        <arg name="grid_rangeMax"                        default="10.0"/>  <!-- max range for the grid, in semantic octomap is max range of occupied points -->
        <arg name="grid_semanticDepthFusionCorrection"   default="$(arg grid_semanticDepthFusionCorrection)"/>
        <arg name="grid_semanticGroundCorrection"        default="$(arg grid_semanticGroundCorrection)"/>
        <arg name="grid_outlierRemoval"                  default="$(arg grid_outlierRemoval)"/>
        <arg name="OctoMapNumThreads"                    default="5" />
        <arg name="octomap_raytracing"                   default="$(arg octomap_raytracing)"/>      <!-- raytracing at the semantic octomap update. uses grid_raytracingMaxRange to set the max range -->
        <arg name="grid_raytracingMaxRange"              default="$(arg grid_raytracingMaxRange)"/>
        <arg name="grid_rayTracingMaxHeight"             default="$(arg grid_rayTracingMaxHeight)"/>
        <arg name="grid_rayTracingMaxWidth"              default="$(arg grid_rayTracingMaxWidth)"/>
        <arg name="grid_rayTracingWithGrd"               default="$(arg grid_rayTracingWithGrd)"/>
        <arg name="grid_maxGroundHeight"                 default="$(arg grid_maxGroundHeight)"/>
    </include>

</launch>